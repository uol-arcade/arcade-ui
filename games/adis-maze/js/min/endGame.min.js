var countdown=5,countdownTimer=null,pauseLabel,menuIndex=0,delayTimeRestart=15E3,menuItems=["RETRY","EXIT"],menuItemSprites=[],warningText,cursor,descText,enemySprite,bg,stage=0,lastKeyPress=+new Date;
function createStartMenu(){if(!(game.started||0<stage)){menuIndex=0;menuItems=["START","EXIT"];for(var a=0;a<menuItemSprites.length;a++)null!=menuItemSprites[a]&&"undefined"!=typeof menuItemSprites&&menuItemSprites[a].destroy();"undefined"!=typeof enemySprite&&enemySprite.destroy();menuItemSprites=[];var b=game.world.centerX,c=game.world.centerY;bg=game.add.sprite(0,0,"black");bg.width=GameSettings.width;bg.height=GameSettings.height;bg.alpha=1;pauseLabel=game.add.sprite(b,c-64,"logo");pauseLabel.anchor.setTo(.5,
.5);pauseLabel.scale.setTo(2,2);for(a=0;a<menuItems.length;a++){var d=game.add.text(b,c+64+32*a,menuItems[a],{font:"12pt Press Start 2P",fill:"#fff"});d.anchor.setTo(.5,.5);menuItemSprites.push(d)}cursor=game.add.text(0,0,"\x3c",{font:"12pt Press Start 2P",fill:"#fff"});cursor.anchor.setTo(.5,.5)}}
function startGame(){var a=game.world.centerX,b=game.world.centerY;pauseLabel.destroy();var c=["arrow keys","d-pad/arrow keys"][+(null!=navigator.getGamepads()[0])],d=["ENTER","ENTER/START"][+(null!=navigator.getGamepads()[0])];c="Use the "+c+"\nto move Adi around.\n\nCollect all the coins and\navoid the enemies to win\nthe level! You have 3 lives\nso be careful!\n\nBy playing this game you are\ncontributing to our research."+("\n\nBy pressing "+d+" you are\n consenting to your gameplay\n data being recorded.");
c+="\n\nFor more information\ncontact researcharcade@gmail.com";stage++;pauseLabel=game.add.text(a,b,c,{fill:"#fff",font:"8pt Press Start 2P",align:"center"});pauseLabel.anchor.setTo(.5,.5);cursor.destroy();for(a=0;a<menuItemSprites.length;a++)menuItemSprites[a].destroy()}function destroyStartMenu(){pauseLabel.destroy();bg.destroy();"undefined"!=typeof warningText&&warningText.destroy();game.started=!0}
function generateNewLevel(){game.ended=!1;game.won=!1;game.started=!0;countdown=5;for(var a=0;a<enemies.length;a++)"undefined"!==typeof enemies[a].timer&&null!=enemies[a].timer&&clearInterval(enemies[a].timer),enemies[a].sprite.destroy();enemies=[];"undefined"!=typeof warningText&&warningText.destroy();for(a=0;a<walls.length;a++)walls[a].destroy();walls=[];grid=[];for(a=0;a<coinMap.length;a++)0!=coinMap[a].data&&coinMap[a].sprite.destroy();coinMap=[];"undefined"!=typeof character&&character.destroy();
for(a=0;a<menuItemSprites.length;a++)menuItemSprites[a].destroy();menuItemSprites=[];"undefined"!=typeof pauseLabel&&pauseLabel.destroy();"undefined"!=typeof cursor&&cursor.destroy();"undefined"!=typeof bg&&bg.destroy();"undefined"!=typeof progressBar&&progressBar.destroy();"undefined"!=typeof descText&&descText.destroy();clearInterval(countdownTimer);countdownTimer=null;pickedUpCoins=0;isInterpolating=!1;originalCoinAmount=0;nextDirection=[];playerDirection={x:0,y:0};score=0;lives=3;logger.reset();
start()}
function endGameRestart(a){gameoverSound.play();lastKeyPress=+new Date;game.won=!0;var b=game.world.centerX,c=game.world.centerY;bg=game.add.sprite(0,0,"black");bg.width=GameSettings.width;bg.height=GameSettings.height;bg.alpha=.8;pauseLabel=game.add.text(b,c-64,lives+(1==lives?" LIFE LEFT":" LIVES LEFT"),{font:"16pt Press Start 2P",fill:"#fff"});logger.onDeath(a,!1);var d=["ENTER","START"][+(null!=navigator.getGamepads()[0])];descText=game.add.text(b,c+18,"YOU WERE CAUGHT BY "+a.name+"\n\n\n\nPRESS "+d+
" TO CONTINUE",{font:"10pt Press Start 2P",fill:"#fff",align:"center"});for(d=0;d<enemies.length;d++)enemies[d].sprite.destroy();clearTimeout(switchSpriteTimer);switchSpriteTimer=null;menuIndex=0;enemySprite=game.add.sprite(b,c+16,"enemy"+(a.aiType+1));enemySprite.scale.setTo(2,2);enemySprite.animations.add("walk");enemySprite.play("walk",12,!0);enemySprite.anchor.setTo(.5,.5);descText.anchor.setTo(.5,.5);pauseLabel.anchor.setTo(.5,.5)}
function startGameInput(a){if(a.up.downDuration(10)||gamepadUpPressed())menuIndex+=1,menuIndex%=menuItems.length,blipSound.play();else if(a.down.downDuration(10)||gamepadDownPressed())menuIndex=0>menuIndex-1?menuItems.length-1:menuIndex-1,blipSound.play();else if(game.input.keyboard.downDuration(Phaser.KeyCode.ENTER,1)){if(0<stage){destroyStartMenu();return}0==menuIndex?startGame():1==menuIndex&&(window.location.href="http://games.researcharcade.com/")}cursor.position.setTo(game.world.centerX+64,
game.world.centerY+64+32*menuIndex)}
function endGameInput(a){var b=+new Date;if(1E4<=b-lastKeyPress){var c=delayTimeRestart-(b-lastKeyPress);c=Math.round(c/1E3);"undefined"!=typeof warningText&&warningText.destroy();if(0>c)return;var d=game.world.centerX,e=game.world.centerY;warningText=game.add.text(d-108,e+96,"EXITING IN "+c+" SECONDS",{fill:"#fff",font:"8pt Press Start 2P",align:"center"})}b-lastKeyPress>=delayTimeRestart&&"http://games.researcharcade.com/"!=window.location.href&&(window.location.href="http://games.researcharcade.com/");
if(a.up.downDuration(10)||gamepadUpPressed())menuIndex+=1,lastKeyPress=+new Date,blipSound.play(),menuIndex%=menuItems.length;else if(a.down.downDuration(10)||gamepadDownPressed())menuIndex=0>menuIndex-1?menuItems.length-1:menuIndex-1,blipSound.play(),lastKeyPress=+new Date;else if(game.input.keyboard.isDown(Phaser.KeyCode.ENTER)||gamepadStartPressed())lastKeyPress=+new Date,0==menuIndex?(generateNewLevel(),game.started=!1,stage=0,createStartMenu()):1==menuIndex&&(window.location.href="http://games.researcharcade.com/");
d=game.world.centerX;e=game.world.centerY;cursor.position.setTo(d+64,e+48+32*menuIndex)}
function wonGameInput(a){a=+new Date;if(1E4<=a-lastKeyPress){var b=delayTimeRestart-(a-lastKeyPress);b=Math.round(b/1E3);"undefined"!=typeof warningText&&warningText.destroy();if(0>b)return;warningText=game.add.text(game.world.centerX-108,game.world.centerY+96,"EXITING IN "+b+" SECONDS",{fill:"#fff",font:"8pt Press Start 2P",align:"center"})}a-lastKeyPress>=delayTimeRestart&&"http://games.researcharcade.com/"!=window.location.href&&(window.location.href="http://games.researcharcade.com/");if(game.input.keyboard.isDown(Phaser.KeyCode.ENTER)||
gamepadStartPressed()){"undefined"!=typeof warningText&&warningText.destroy();descText.destroy();a=score;descText.destroy();bg.destroy();enemySprite.destroy();pauseLabel.destroy();game.ended=game.won=!1;for(b=0;b<enemies.length;b++)enemies[b].sprite.destroy();clearInterval(countdownTimer);enemies=[];addEnemies();score=a}}
function winGame(){winSound.play();winSound.volume=1;lastKeyPress=99999999;game.won=!0;var a=game.world.centerX,b=game.world.centerY;bg=game.add.sprite(0,0,"black");bg.width=GameSettings.width;bg.height=GameSettings.height;bg.alpha=.8;pauseLabel=game.add.text(a,b-64,"YOU WON!",{font:"16pt Press Start 2P",fill:"#70d1ff"});descText=game.add.text(a,b-16,"YOUR SCORE IS "+score,{font:"10pt Press Start 2P",fill:"#fff"});clearTimeout(switchSpriteTimer);switchSpriteTimer=null;menuIndex=0;logger.onWin();character.position.x=
a;character.position.y=b+16;character.scale.setTo(2,2);setTimeout(function(){character.loadTexture("player-scream",0);character.animations.add("scream");character.animations.play("scream",12,!0)},1E3);setTimeout(function(){countdownTimer=setInterval(function(){descText.destroy();blipSound.play();0==countdown?generateNewLevel():(descText=game.add.text(a,b-16,"NEW LEVEL IN "+countdown--+" SECONDS",{font:"10pt Press Start 2P",fill:"#fff"}),descText.anchor.setTo(.5,.5))},1E3)},3E3);game.world.bringToTop(character);
descText.anchor.setTo(.5,.5);pauseLabel.anchor.setTo(.5,.5)}
function endGame(a){gameoverSound.play();lastKeyPress=+new Date;menuIndex=0;menuItems=["RETRY","EXIT"];for(var b=0;b<menuItemSprites.length;b++)null!=menuItemSprites[b]&&"undefined"!=typeof menuItemSprites&&menuItemSprites[b].destroy();menuItemSprites=[];if("undefined"==typeof game.ended||0==game.ended)game.ended=!0;clearTimeout(switchSpriteTimer);switchSpriteTimer=null;character.destroy();var c=game.world.centerX,d=game.world.centerY;bg=game.add.sprite(0,0,"black");bg.width=GameSettings.width;bg.height=
GameSettings.height;bg.alpha=.8;cursor=game.add.text(0,0,"\x3c",{font:"12pt Press Start 2P",fill:"#fff"});cursor.anchor.setTo(.5,.5);pauseLabel=game.add.text(c,d-96,"GAME OVER",{font:"20pt Press Start 2P",fill:"#ff0000"});descText=game.add.text(c,d-32-8,"YOU WERE CAUGHT BY "+a.name,{font:"10pt Press Start 2P",fill:"#fff"});logger.onDeath(a,!0);for(b=0;b<enemies.length;b++)enemies[b].sprite.destroy();clearTimeout(switchSpriteTimer);switchSpriteTimer=null;menuIndex=0;enemySprite=game.add.sprite(c,d,
"enemy"+(a.aiType+1));enemySprite.scale.setTo(2,2);enemySprite.animations.add("walk");enemySprite.play("walk",12,!0);enemySprite.anchor.setTo(.5,.5);descText.anchor.setTo(.5,.5);for(b=0;b<menuItems.length;b++)a=game.add.text(c,d+48+32*b,menuItems[b],{font:"12pt Press Start 2P",fill:"#fff"}),a.anchor.setTo(.5,.5),menuItemSprites.push(a);pauseLabel.anchor.setTo(.5,.5)};
