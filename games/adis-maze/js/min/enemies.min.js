var enemyGroup,enemyNames=["DITSY","STINKY","SQUIFFY","CHOMP","RED"];function randomFreeIndex(){for(;;){var b=Math.floor(Math.random()*grid.length);if(0==grid[b])return b}}
function addEnemies(){enemyGroup=game.add.group();for(var b=0;5>b;b++){var a=randomFreeIndex(),c=get2DFrom1D(a);a=worldToGrid(c.x,c.y);var d=Math.abs(a.y-playerPos.y);if(5>Math.abs(a.x-playerPos.x)||5>d)b--;else{if(1==b){if(!onBorderXY(a.x,a.y)){b--;continue}if(1==a.x&&1==a.y){b--;continue}if(a.x==GameSettings.cols-2&&1==a.y){b--;continue}if(a.x==GameSettings.cols-2&&a.y==GameSettings.rows-2){b--;continue}if(1==a.x&&a.y==GameSettings.rows-2){b--;continue}}a=worldToGrid(c.x,c.y);c=game.add.sprite(c.x,
c.y,"enemy"+(b+1));c.anchor.x=.5;c.anchor.y=.5;c.animations.add("walk");c.animations.play("walk",12,!0);enemyGroup.add(c);enemies.push({isInterpolating:!1,sprite:c,aiType:b,speed:1.1,x:a.x,y:a.y,timer:null,patrol:!0,lastX:a.x,lastY:a.y,lastJunction:0,destDirection:[],destPosition:[],name:enemyNames[b],dirX:1,dirY:0});4==b&&(c.timer=setInterval(function(){switchBehaviours(enemies[enemies.length-1])},1E3*(10+Math.floor(3*Math.random()))));1!=b?selectRandomDirection(grid,enemies[enemies.length-1]):(c=
enemies[enemies.length-1],c.x==GameSettings.cols-2?changeEnemyDirection(c,0,1):1==c.y?changeEnemyDirection(c,1,0):c.y==GameSettings.rows-2?changeEnemyDirection(c,-1,0):1==c.x&&changeEnemyDirection(c,0,-1))}}}function switchBehaviours(b){"undefined"!=typeof b&&(b.patrol=!b.patrol)}
function moveEnemy(b,a){var c=get1DFrom2D(a.x+a.dirX,a.y+a.dirY);0==b[c]||a.isInterpolating?(a.sprite.position.x+=a.dirX*a.speed,a.sprite.position.y+=a.dirY*a.speed,c=worldToGrid(a.sprite.position.x,a.sprite.position.y),a.x=c.x,a.y=c.y,(c=hasHitJunction(b,a))&&0==a.aiType&&selectRandomDirection(b,a),2==a.aiType?chasePlayer(b,a,c):1==a.aiType?patrolBorder(b,a):3==a.aiType?moveToCentre(b,a):4==a.aiType&&moveMixed(b,a)):(a.isInterpolating=!0,b=gridToWorld(a.x,a.y),game.add.tween(a.sprite).to({x:[b.x],
y:[b.y]},200,"Linear",!0).onComplete.add(function(){a.isInterpolating=!1},this))}function moveMixed(b,a){moveMixedBehaviour(b,a)}function moveMixedBehaviour(b,a){a.patrol?moveToCentre(b,a,!1):patrolBorder(b,a,!1,!0)}
function moveToCentre(b,a,c){c=void 0===c?!0:c;var d=canSeePlayer(b,a),e=getHitJunction(b,a),f=gridToWorld(a.x,a.y),g=2>Math.abs(a.sprite.position.y-f.y);2>Math.abs(a.sprite.position.x-f.x)&&g&&(a.lastX!=a.x||a.lastY!=a.y)&&(a.lastX=a.x,a.lastY=a.y,(null!=d||0<a.destDirection.length)&&c?chasePlayer(b,a,-1!=e):(a.destDirection=a.destPosition=[],-1!=e&&moveToCentreBehaviour(b,a)))}
function moveToCentreBehaviour(b,a){for(var c=getDistantNeighbours(b,vertices,a.x,a.y),d=GameSettings.cols/2,e=GameSettings.rows/2,f=[],g=GameSettings.cols-1,h=0;h<c.length;h++){var k=c[h].direction;if(k.x!=-a.dirX||k.y!=-a.dirY){k=Math.abs(d-c[h].x)+Math.abs(e-c[h].y);for(var l=0;l<g-k;l++)f.push(c[h].direction)}}0>=f.length?selectRandomDirection(b,a):(b=f[Math.floor(Math.random()*f.length)],changeEnemyDirection(a,b.x,b.y))}
function canSeePlayer(b,a){for(var c=getMoveDirections(b,a.x,a.y),d=0;d<c.length;d++){for(var e=a.x,f=a.y,g=c[d],h=0;h<10*Math.abs(g.x);h++){e=0>g.x?e-1:e+1;if(1==b[get1DFrom2D(e,f)])break;if(e==playerPos.x&&f==playerPos.y)return{dir:g,dist:h,x:playerPos.x,y:playerPos.y}}e=a.x;f=a.y;for(var k=0;k<10*Math.abs(g.y);k++){f=0>g.y?f-1:f+1;if(1==b[get1DFrom2D(e,f)])break;if(e==playerPos.x&&f==playerPos.y)return{dir:g,dist:h,x:playerPos.x,y:playerPos.y}}}return null}
function chasePlayer(b,a,c){var d=canSeePlayer(b,a),e=null!=d,f=gridToWorld(a.x,a.y),g=2>Math.abs(a.sprite.position.y-f.y);2>Math.abs(a.sprite.position.x-f.x)&&g&&(e?(a.destDirection=[d.dir.x,d.dir.y],a.destPosition=[playerPos.x,playerPos.y],a.dirX==a.destDirection[0]&&a.dirY==a.destDirection[1]||changeEnemyDirection(a,d.dir.x,d.dir.y)):a.x==a.destPosition[0]&&a.y==a.destPosition[1]&&(a.destDirection=a.destPosition=[],selectRandomDirection(b,a)),c&&(e||0!=a.destPosition.length||selectRandomDirection(b,
a)))}function onBorderXY(b,a){return onBorder(null,{x:b,y:a})}function onBorder(b,a){b=a.x;a=a.y;return 1==b||b==GameSettings.cols-2||1==a||a==GameSettings.rows-2}
function patrolBorder(b,a,c,d){c=void 0===c?!0:c;d=void 0===d?!1:d;var e=canSeePlayer(b,a),f=getHitJunction(b,a),g=gridToWorld(a.x,a.y),h=2>Math.abs(a.sprite.position.y-g.y);2>Math.abs(a.sprite.position.x-g.x)&&h&&(a.lastX!=a.x||a.lastY!=a.y)&&(a.lastX=a.x,a.lastY=a.y,(null!=e||0<a.destDirection.length)&&c?chasePlayer(b,a,-1!=f):(a.destDirection=a.destPosition=[],onBorder(b,a)?(getNeighboursEx(b,a.x,a.y),d?(a.x==GameSettings.cols-2?changeEnemyDirection(a,0,-1):1==a.y?changeEnemyDirection(a,-1,0):
a.y==GameSettings.rows-2?changeEnemyDirection(a,1,0):1==a.x?changeEnemyDirection(a,0,1):selectRandomDirection(b,a),1==a.x&&1==a.y?changeEnemyDirection(a,0,1):a.x==GameSettings.cols-2&&1==a.y?changeEnemyDirection(a,-1,0):a.x==GameSettings.cols-2&&a.y==GameSettings.cols-2?changeEnemyDirection(a,0,-1):1==a.x&&a.y==GameSettings.cols-2&&changeEnemyDirection(a,1,0)):(a.x==GameSettings.cols-2?changeEnemyDirection(a,0,1):1==a.y?changeEnemyDirection(a,1,0):a.y==GameSettings.rows-2?changeEnemyDirection(a,-1,
0):1==a.x?changeEnemyDirection(a,0,-1):selectRandomDirection(b,a),1==a.x&&1==a.y?changeEnemyDirection(a,1,0):a.x==GameSettings.cols-2&&1==a.y?changeEnemyDirection(a,0,1):a.x==GameSettings.cols-2&&a.y==GameSettings.cols-2?changeEnemyDirection(a,-1,0):1==a.x&&a.y==GameSettings.cols-2&&changeEnemyDirection(a,0,-1))):selectRandomDirection(b,a)))}
function selectRandomDirection(b,a){var c=getNeighboursEx(b,a.x,a.y);b=[];var d=[];0==c.up&&b.push([0,-1]);0==c.down&&b.push([0,1]);0==c.left&&b.push([-1,0]);0==c.right&&b.push([1,0]);for(c=0;c<b.length;c++){var e=b[c];e[0]==-a.dirX&&e[1]==-a.dirY||d.push(e)}1>=b.length&&(d=b);b=d[Math.floor(Math.random()*d.length)];changeEnemyDirection(a,b[0],b[1])}
function changeEnemyDirection(b,a,c){b.dirX=a;b.dirY=c;0<a?b.sprite.scale.x=-1:0>a&&(b.sprite.scale.x=1);var d=gridToWorld(b.x,b.y);0==grid[get1DFrom2D(b.x+a,b.y+c)]&&(b.sprite.position.x=d.x,b.sprite.position.y=d.y)}function hasHitJunction(b,a){b=getHitJunction(b,a);if(-1!=b){var c=get2DFrom1D(b);if(2<Math.abs(c.x-a.sprite.position.x)||2<Math.abs(c.y-a.sprite.position.y)||b==a.lastJunction)return!1;a.lastJunction=b;return!0}return!1}
function getHitJunctionXY(b,a,c){return getHitJunction(b,{x:a,y:c})}function getHitJunction(b,a){return 3<=getNeighbourScoreEx(b,a.x,a.y)?get1DFrom2D(a.x,a.y):-1}function updateEnemy(b,a){moveEnemy(b,a);1==a.aiType&&.1>+new Date/15E3%1&&.1>Math.random()&&(b=game.add.sprite(a.sprite.position.x,a.sprite.position.y,"smoke"),b.animations.add("smoke"),b.anchor.setTo(.5,.5),b.scale.setTo(1,1),b.angle=360*Math.random(),b.animations.play("smoke",12,!1),b.lifespan=3E3);checkCollision(a)}
function checkCollision(b){var a=Math.abs(b.sprite.position.y-character.position.y);10>Math.abs(b.sprite.position.x-character.position.x)&&10>a&&(0>=--lives?endGame(b):endGameRestart(b))};
